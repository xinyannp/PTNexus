import{m as re,r as c,p as P,O as ue,o as de,f as y,z as m,c as V,h as d,u as pe,b as o,w as a,e as g,x as z,X as ce,a4 as me,v as ge,j as J,l as S,i as r,t as B,aj as fe,ai as ve,Q as _e,g as p}from"./index-BhbkXXvN.js";const ke={class:"cookie-view-container"},ye={class:"top-actions cookie-actions glass-pagination"},we={class:"right-action-group"},be={class:"settings-view"},Ve={key:0,class:"role-tag role-both"},Se={key:1,class:"role-tag role-source"},Ce={key:2,class:"role-tag role-target"},he={style:{display:"flex","justify-content":"center","align-items":"center",width:"100%",height:"100%"}},xe={class:"settings-footer glass-pagination"},Ue={class:"pagination-container"},Pe={class:"page-size-text"},ze={key:0,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},Be={key:1,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},Le={class:"dialog-footer"},w="/api",$e={__name:"SitesSettings",setup(Re){const L=c(!1),E=c([]),I=c(new Set),F=c([]),$=c(!1),R=c(!1),u=c({url:"",key:"",e2e_password:""}),x=c(""),C=c("existing_supported"),f=c({currentPage:1,pageSize:30,total:0}),h=c(!1),K=c(null),n=c({id:null,site:"",nickname:"",base_url:"",special_tracker_domain:"",group:"",cookie:"",passkey:"",speed_limit:0}),Y=P(()=>{const t=new Map;for(const e of F.value||[])e&&e.site&&t.set(String(e.site),e);return t}),M=t=>t?.site&&Y.value.get(String(t.site))||null,N=t=>{const e=M(t);return e?e.is_source&&e.is_target?"both":e.is_source?"source":e.is_target?"target":"none":"none"},T=t=>{const e=!!t?.has_cookie,s=!!t?.has_passkey,i=["hddolby","m-team","hdtime","rousi"].includes(t?.site);return(!(t?.site!=="rousi")||e)&&(!i||s)},O=P(()=>["existing_supported","supported"].includes(C.value)),j=P(()=>{let t=E.value||[];C.value==="existing_supported"?t=t.filter(s=>{const i=M(s);return!!(i?.is_source||i?.is_target)&&I.value.has(s.site)}):C.value==="supported"&&(t=t.filter(s=>{const i=M(s);return!!(i?.is_source||i?.is_target)}));const e=x.value.trim().toLowerCase();return e&&(t=t.filter(s=>{const i=(s.nickname||"").toLowerCase(),k=(s.site||"").toLowerCase(),v=(s.group||"").toLowerCase();return i.includes(e)||k.includes(e)||v.includes(e)})),O.value?t.slice().sort((s,i)=>{const k=T(s)?0:1,v=T(i)?0:1;return k!==v?v-k:String(s?.nickname||"").localeCompare(String(i?.nickname||""))}):t}),q=P(()=>{f.value.total=j.value.length;const t=(f.value.currentPage-1)*f.value.pageSize,e=t+f.value.pageSize;return j.value.slice(t,e)});ue(x,()=>{f.value.currentPage=1}),de(()=>{H(),U()});const H=async()=>{try{const t=await y.get(`${w}/settings`);t.data&&t.data.cookiecloud&&(u.value.url=t.data.cookiecloud.url||"",u.value.key=t.data.cookiecloud.key||"",u.value.e2e_password="")}catch{m.error("加载CookieCloud配置失败！")}},U=async()=>{$.value=!0;try{const[t,e,s]=await Promise.all([y.get(`${w}/sites`,{params:{filter_by_torrents:"all"}}),y.get(`${w}/sites`,{params:{filter_by_torrents:"active"}}),y.get(`${w}/sites/status`)]);E.value=t.data,I.value=new Set((e.data||[]).map(i=>i.site)),F.value=s.data}catch{m.error("获取站点列表失败！")}finally{$.value=!1}},Q=()=>{f.value.currentPage=1},W=({row:t})=>O.value?T(t)?"":"row-config-incomplete":"",X=async()=>{if(!u.value.url||!u.value.key){m.warning("CookieCloud URL 和 KEY 不能为空！");return}R.value=!0;try{await y.post(`${w}/settings`,{cookiecloud:u.value});const t=await y.post(`${w}/cookiecloud/sync`,u.value);if(t.data.success){let e=t.data.message;e&&(e=e.replace(/在 CookieCloud 中另有 \d+ 个未匹配的 Cookie。?/,"")),m.success(`配置已保存. ${e||"同步完成！"}`),await U()}else m.error(t.data.message||"同步失败，但配置已保存。")}catch(t){const e=t.response?.data?.message||"操作失败，请检查网络或后端服务。";m.error(e)}finally{R.value=!1}},G=t=>{const e=JSON.parse(JSON.stringify(t));n.value=e,h.value=!0},Z=async()=>{L.value=!0;try{const t=JSON.parse(JSON.stringify(n.value));t.cookie&&(t.cookie=t.cookie.trim());const e=await y.post(`${w}/sites/update`,t);e.data.success?(m.success(e.data.message),h.value=!1,await U()):m.error(e.data.message||"操作失败！")}catch(t){const e=t.response?.data?.message||"请求失败，请检查网络或后端服务。";m.error(e)}finally{L.value=!1}},ee=t=>{_e.confirm("","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,message:`您确定要删除站点【${t.nickname}】吗？<br/>可以通过修改 config.json 然后重启恢复。`}).then(async()=>{try{const e=await y.post(`${w}/sites/delete`,{id:t.id});e.data.success?(m.success("站点已删除。"),await U()):m.error(e.data.message||"删除失败！")}catch(e){const s=e.response?.data?.message||"删除请求失败。";m.error(s)}}).catch(()=>{m.info("操作已取消。")})};return(t,e)=>{const s=g("el-input"),i=g("el-form-item"),k=g("el-icon"),v=g("el-button"),A=g("el-form"),_=g("el-table-column"),b=g("el-tag"),te=g("el-table"),D=g("el-radio-button"),le=g("el-radio-group"),oe=g("el-pagination"),ae=g("el-input-number"),se=g("el-dialog"),ie=ge("loading");return p(),V("div",ke,[d("div",ye,[o(A,{model:u.value,inline:"",class:"cookie-cloud-form"},{default:a(()=>[o(i,{label:"CookieCloud"},{default:a(()=>[o(s,{modelValue:u.value.url,"onUpdate:modelValue":e[0]||(e[0]=l=>u.value.url=l),placeholder:"http://127.0.0.1:8088",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),o(i,{label:"KEY"},{default:a(()=>[o(s,{modelValue:u.value.key,"onUpdate:modelValue":e[1]||(e[1]=l=>u.value.key=l),placeholder:"KEY (UUID)",clearable:"",style:{width:"100px"}},null,8,["modelValue"])]),_:1}),o(i,{label:"端对端密码"},{default:a(()=>[o(s,{modelValue:u.value.e2e_password,"onUpdate:modelValue":e[2]||(e[2]=l=>u.value.e2e_password=l),type:"password","show-password":"",placeholder:"端对端加密密码",clearable:"",style:{width:"125px"}},null,8,["modelValue"])]),_:1}),o(i,null,{default:a(()=>[o(v,{type:"primary",size:"large",onClick:X,loading:R.value},{default:a(()=>[o(k,null,{default:a(()=>[o(z(ce))]),_:1}),e[17]||(e[17]=d("span",null,"同步Cookie",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),d("div",we,[o(s,{modelValue:x.value,"onUpdate:modelValue":e[3]||(e[3]=l=>x.value=l),placeholder:"搜索站点昵称/标识/官组",clearable:"","prefix-icon":z(me),class:"search-input"},null,8,["modelValue","prefix-icon"])])]),pe((p(),V("div",be,[o(te,{data:q.value,class:"settings-table glass-table",height:"100%","row-class-name":W},{default:a(()=>[o(_,{prop:"nickname",label:"站点昵称",width:"100",sortable:""}),o(_,{label:"支持",width:"100",align:"center"},{default:a(l=>[N(l.row)==="both"?(p(),V("span",Ve," 源站/目标站 ")):N(l.row)==="source"?(p(),V("span",Se," 源站 ")):N(l.row)==="target"?(p(),V("span",Ce," 目标站 ")):J("",!0)]),_:1}),o(_,{prop:"site",label:"站点标识",width:"100","show-overflow-tooltip":""}),o(_,{prop:"base_url",label:"基础URL",width:"150","show-overflow-tooltip":""}),o(_,{prop:"group",label:"官组","show-overflow-tooltip":""}),o(_,{label:"限速",width:"100",align:"center"},{default:a(l=>[d("div",he,[l.row.speed_limit==0?(p(),S(b,{key:0,type:"error",size:"small"},{default:a(()=>[...e[18]||(e[18]=[r(" 当前不限速，重启恢复默认限速 ",-1)])]),_:1})):l.row.speed_limit>999?(p(),S(b,{key:1,type:"success",size:"small"},{default:a(()=>[...e[19]||(e[19]=[r(" 不限速 ",-1)])]),_:1})):(p(),S(b,{key:2,type:"primary",size:"small"},{default:a(()=>[r(B(l.row.speed_limit)+" MB/s ",1)]),_:2},1024))])]),_:1}),o(_,{label:"Cookie",width:"100",align:"center"},{default:a(l=>[l.row.site==="rousi"?(p(),S(b,{key:0,type:"info"},{default:a(()=>[...e[20]||(e[20]=[r(" 无需配置 ",-1)])]),_:1})):(p(),S(b,{key:1,type:l.row.has_cookie?"success":"danger"},{default:a(()=>[r(B(l.row.has_cookie?"已配置":"未配置"),1)]),_:2},1032,["type"]))]),_:1}),o(_,{label:"Passkey",width:"100",align:"center"},{default:a(l=>[["hddolby","m-team","hdtime","rousi"].includes(l.row.site)?(p(),S(b,{key:0,type:l.row.has_passkey?"success":"danger"},{default:a(()=>[r(B(l.row.has_passkey?"已配置":"未配置"),1)]),_:2},1032,["type"])):(p(),S(b,{key:1,type:"success"},{default:a(()=>[...e[21]||(e[21]=[r(" 自动获取 ",-1)])]),_:1}))]),_:1}),o(_,{label:"操作",width:"180",align:"center",fixed:"right"},{default:a(l=>[o(v,{type:"primary",icon:z(fe),link:"",onClick:ne=>G(l.row)},{default:a(()=>[...e[22]||(e[22]=[r(" 编辑 ",-1)])]),_:1},8,["icon","onClick"]),o(v,{type:"danger",icon:z(ve),link:"",onClick:ne=>ee(l.row)},{default:a(()=>[...e[23]||(e[23]=[r(" 删除 ",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])])),[[ie,$.value]]),d("div",xe,[o(le,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=l=>C.value=l),onChange:Q},{default:a(()=>[o(D,{label:"existing_supported"},{default:a(()=>[...e[24]||(e[24]=[r("已有支持站点",-1)])]),_:1}),o(D,{label:"supported"},{default:a(()=>[...e[25]||(e[25]=[r("所有支持站点",-1)])]),_:1}),o(D,{label:"all"},{default:a(()=>[...e[26]||(e[26]=[r("所有站点",-1)])]),_:1})]),_:1},8,["modelValue"]),d("div",Ue,[d("div",Pe,B(f.value.pageSize)+" 条/页",1),o(oe,{"current-page":f.value.currentPage,"onUpdate:currentPage":e[5]||(e[5]=l=>f.value.currentPage=l),"page-size":f.value.pageSize,"onUpdate:pageSize":e[6]||(e[6]=l=>f.value.pageSize=l),total:f.value.total,layout:"total, prev, pager, next, jumper",background:""},null,8,["current-page","page-size","total"])])]),o(se,{modelValue:h.value,"onUpdate:modelValue":e[16]||(e[16]=l=>h.value=l),title:"编辑站点",width:"700px","close-on-click-modal":!1},{footer:a(()=>[d("span",Le,[o(v,{onClick:e[15]||(e[15]=l=>h.value=!1)},{default:a(()=>[...e[32]||(e[32]=[r("取消",-1)])]),_:1}),o(v,{type:"primary",onClick:Z,loading:L.value},{default:a(()=>[...e[33]||(e[33]=[r(" 保存 ",-1)])]),_:1},8,["loading"])])]),default:a(()=>[o(A,{model:n.value,ref_key:"siteFormRef",ref:K,"label-width":"140px","label-position":"left"},{default:a(()=>[o(i,{label:"站点标识",prop:"site",required:""},{default:a(()=>[o(s,{modelValue:n.value.site,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.site=l),placeholder:"例如：pt",disabled:""},null,8,["modelValue"]),e[27]||(e[27]=d("div",{class:"form-tip"},"站点标识不可修改。",-1))]),_:1}),o(i,{label:"站点昵称",prop:"nickname",required:""},{default:a(()=>[o(s,{modelValue:n.value.nickname,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.nickname=l),placeholder:"例如：PT站"},null,8,["modelValue"])]),_:1}),o(i,{label:"基础URL",prop:"base_url"},{default:a(()=>[o(s,{modelValue:n.value.base_url,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.base_url=l),placeholder:"例如：pt.com"},null,8,["modelValue"]),e[28]||(e[28]=d("div",{class:"form-tip"},"用于拼接种子详情页链接。",-1))]),_:1}),o(i,{label:"Tracker域名",prop:"special_tracker_domain"},{default:a(()=>[o(s,{modelValue:n.value.special_tracker_domain,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.special_tracker_domain=l),placeholder:"例如：pt-tracker.com"},null,8,["modelValue"]),e[29]||(e[29]=d("div",{class:"form-tip"}," 如果站点的Tracker域名与主域名的二级域名（则域名去掉前缀后缀部分）不同，请在此填写。 ",-1))]),_:1}),o(i,{label:"关联官组",prop:"group"},{default:a(()=>[o(s,{modelValue:n.value.group,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.group=l),placeholder:"例如：PT, PTWEB"},null,8,["modelValue"]),e[30]||(e[30]=d("div",{class:"form-tip"},"用于识别种子所属发布组，多个组用英文逗号(,)分隔。",-1))]),_:1}),o(i,{label:"Cookie",prop:"cookie"},{default:a(()=>[o(s,{modelValue:n.value.cookie,"onUpdate:modelValue":e[12]||(e[12]=l=>n.value.cookie=l),type:"textarea",rows:3,placeholder:n.value.site==="rousi"?"无需设置":"从浏览器获取的Cookie字符串",disabled:n.value.site==="rousi"},null,8,["modelValue","placeholder","disabled"])]),_:1}),o(i,{label:"Passkey",prop:"passkey"},{default:a(()=>[o(s,{modelValue:n.value.passkey,"onUpdate:modelValue":e[13]||(e[13]=l=>n.value.passkey=l),placeholder:"站点的Passkey"},null,8,["modelValue"]),n.value.site==="hddolby"?(p(),V("div",ze," 杜比的passkey为种子详情页复制种子链接时downhash=后的部分 ")):n.value.site==="rousi"?(p(),V("div",Be," 肉丝的passkey在个人用户-设置-passkey ")):J("",!0)]),_:1}),o(i,{label:"上传限速 (MB/s)",prop:"speed_limit"},{default:a(()=>[o(ae,{modelValue:n.value.speed_limit,"onUpdate:modelValue":e[14]||(e[14]=l=>n.value.speed_limit=l),min:0,max:1e3,placeholder:"为防止失误操作导致超速，当设置为 0 时重启会自动设置为默认限速",style:{width:"100%"}},null,8,["modelValue"]),e[31]||(e[31]=d("div",{class:"form-tip",style:{color:"red","font-size":"14px"}},[r(" 单位为 MB/s，为防止误操作导致超速，当设置为 0 时重启会恢复默认限速"),d("br"),r(" 如缺点设置不限速可输入一个极大的数值，超过 999 会显示不限速 ")],-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ne=re($e,[["__scopeId","data-v-cf7c336e"]]);export{Ne as default};
