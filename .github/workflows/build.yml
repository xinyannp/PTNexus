name: æ„å»º Docker é•œåƒ

on:
  workflow_dispatch:

env:
  IMAGE_NAME: pt-nexus

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 1.5. ä¸‹è½½ æ‰¹é‡è½¬ç§ ç¨‹åº
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          PRIVATE_REPO_URL: ${{ secrets.PRIVATE_REPO_URL }}
        run: |
          if [ -n "$PRIVATE_REPO_TOKEN" ] && [ -n "$PRIVATE_REPO_URL" ]; then
            echo "ğŸ“¥ ä¸‹è½½ æ‰¹é‡è½¬ç§ ç¨‹åº"
            
            # åˆ›å»º batch ç›®å½•
            mkdir -p batch
            
            # ä¸‹è½½ batch.go æ–‡ä»¶
            curl -H "Authorization: token $PRIVATE_REPO_TOKEN" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -L "$PRIVATE_REPO_URL/refs/heads/main/batch/batch.go" \
                 -o batch/batch.go
            
            if [ -f batch/batch.go ]; then
              echo "âœ… æˆåŠŸä¸‹è½½ batch/batch.go"
              echo "æ–‡ä»¶å¤§å°: $(wc -l < batch/batch.go) è¡Œ"
            else
              echo "âŒ ä¸‹è½½ batch/batch.go å¤±è´¥"
              exit 1
            fi
          else
            echo "âš ï¸  æœªé…ç½®ç§æœ‰ä»“åº“è®¿é—®ä¿¡æ¯ï¼Œè·³è¿‡æ–‡ä»¶ä¸‹è½½"
            echo "   è¯·è®¾ç½® PRIVATE_REPO_TOKEN å’Œ PRIVATE_REPO_URL secrets"
          fi

      - name: 2. è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: 3. è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 4. ç™»å½•åˆ° GitHub Container Registry (ghcr.io)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 5. ç™»å½•åˆ° Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 6. å‡†å¤‡ Docker æ ‡ç­¾
        id: prepare-tags
        run: |
          # ä½¿ç”¨é»˜è®¤æ ‡ç­¾ latest
          INPUT_TAGS="latest"

          # å‡†å¤‡ä¸¤ä¸ªä»“åº“çš„åŸºç¡€è·¯å¾„
          GHCR_REPO="ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          DOCKERHUB_REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"

          # ä¸ºæ¯ä¸ªè¾“å…¥æ ‡ç­¾å‡†å¤‡ GHCR å’Œ Docker Hub çš„æ ‡ç­¾
          ALL_TAGS=""
          IFS=',' read -ra TAG_ARRAY <<< "$INPUT_TAGS"
          for tag in "${TAG_ARRAY[@]}"; do
            tag=$(echo "$tag" | xargs)
            GHCR_TAG="${GHCR_REPO}:${tag}"
            DOCKERHUB_TAG="${DOCKERHUB_REPO}:${tag}"

            if [ -z "$ALL_TAGS" ]; then
              ALL_TAGS="${GHCR_TAG},${DOCKERHUB_TAG}"
            else
              ALL_TAGS="${ALL_TAGS},${GHCR_TAG},${DOCKERHUB_TAG}"
            fi
          done

          echo "å¤šæ¶æ„æ ‡ç­¾: $ALL_TAGS"
          echo "tags=$ALL_TAGS" >> $GITHUB_OUTPUT

      - name: 7. æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          # platforms: linux/amd64
          push: true
          tags: ${{ steps.prepare-tags.outputs.tags }}
          cache-from: type=gha,scope=multi-arch
          cache-to: type=gha,mode=max,scope=multi-arch
